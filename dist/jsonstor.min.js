!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jsonstor=t():e.jsonstor=t()}("undefined"!=typeof self?self:this,(()=>(()=>{var e={514:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(828),s=r(632)(),a=r(212);e.exports={AdapterName:"jsonstor-folder",AdapterDescription:"Each document is stored in its own file in a single folder.",GetAdapter:function(e){if("o"!==s.ShortType(e))throw new Error("This adapter requires a Settings parameter.");if("s"!==s.ShortType(e.Path))throw new Error("This adapter requires a Settings.Path string parameter.");function t(){if(!n.existsSync(e.Path))return[];let t=n.readdirSync(e.Path);return t=t.filter((e=>".json"===o.extname(e).toLowerCase())),t}function r(t){let r=o.join(e.Path,t);if(!n.existsSync(r))return null;let i=n.readFileSync(r,"utf8");return JSON.parse(i)}function u(t){n.existsSync(e.Path)||n.mkdirSync(e.Path,{recursive:!0});let r=process.hrtime(),i=o.join(e.Path,`${(new Date).getTime()}.${r[0]}.${r[1]}.json`),s=JSON.stringify(t);n.writeFileSync(i,s,"utf8")}function l(t,r){if(!n.existsSync(e.Path))return;let i=o.join(e.Path,r),s=JSON.stringify(t);n.writeFileSync(i,s,"utf8")}function c(t){if(!n.existsSync(e.Path))return;let r=o.join(e.Path,t);n.existsSync(r)&&n.unlinkSync(r)}let d=a(this,e);return d.DropStorage=async function(t){return new Promise((async(t,r)=>{try{return n.existsSync(e.Path)&&n.rmdirSync(e.Path,{recursive:!0,force:!0}),void t(!0)}catch(e){return void r(e)}}))},d.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return void e(!0)}catch(e){return void t(e)}}))},d.Count=async function(e,n){return new Promise((async(o,i)=>{try{"o"!==s.ShortType(n)&&(n={});let i=s.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=t();if("lu".includes(i)||0===Object.keys(e).length)a=u.length;else for(let t=0;t<u.length;t++){let n=r(u[t]);s.Query(n,e)&&a++}o(a)}catch(e){i(e)}}))},d.InsertOne=async function(e,t){return new Promise((async(r,n)=>{try{if("o"!==s.ShortType(t)&&(t={}),"o"!==s.ShortType(e))throw new Error("Document must be an object.");let n=s.Clone(e);void 0===n._id&&(n._id=i.v4()),u(n),t.ReturnDocuments?r(n):r(1)}catch(e){n(e)}}))},d.InsertMany=async function(e,t){return new Promise((async(r,n)=>{try{if("o"!==s.ShortType(t)&&(t={}),"a"!==s.ShortType(e))throw new Error("Documents must be an array of objects.");let n=0,o=[];for(let r=0;r<e.length;r++){let a=e[r];a=s.Clone(a),void 0===a._id&&(a._id=i.v4()),u(a),n++,t.ReturnDocuments&&o.push(a)}t.ReturnDocuments?r(o):r(n)}catch(e){n(e)}}))},d.FindOne=async function(e,n,o){return new Promise((async(i,a)=>{try{"o"!==s.ShortType(o)&&(o={});let a=s.ShortType(e);if(!"olu".includes(a))throw new Error("Criteria must be an object, null, or undefined.");let u=null,l=t();if("lu".includes(a)||0===Object.keys(e).length)l.length>0&&(u=r(l[0]),u=s.Project(u,n));else for(let t=0;t<l.length;t++){let o=r(l[t]);if(s.Query(o,e)){u=s.Project(o,n);break}}i(u)}catch(e){a(e)}}))},d.FindMany=async function(e,n,o){return new Promise((async(i,a)=>{try{"o"!==s.ShortType(o)&&(o={});let a=s.ShortType(e);if(!"olu".includes(a))throw new Error("Criteria must be an object, null, or undefined.");let u=[],l=t();for(let t=0;t<l.length;t++){let o=r(l[t]);("lu".includes(a)||0===Object.keys(e).length||s.Query(o,e))&&(o=s.Project(o,n),u.push(o))}i(u)}catch(e){a(e)}}))},d.UpdateOne=async function(e,n,o){return new Promise((async(i,a)=>{try{"o"!==s.ShortType(o)&&(o={});let a=s.ShortType(e);if(!"olu".includes(a))throw new Error("Criteria must be an object, null, or undefined.");let u=0,c=null,d=t();if("lu".includes(a)||0===Object.keys(e).length)d.length>0&&(c=r(d[0]),c=s.Update(c,n),l(c,d[0]),u++);else for(let t=0;t<d.length;t++){let o=r(d[t]);if(s.Query(o,e)){c=s.Update(o,n),l(c,d[t]),u++;break}}o.ReturnDocuments?i(c):i(u)}catch(e){a(e)}}))},d.UpdateMany=async function(e,n,o){return new Promise((async(i,a)=>{try{"o"!==s.ShortType(o)&&(o={});let a=s.ShortType(e);if(!"olu".includes(a))throw new Error("Criteria must be an object, null, or undefined.");let u=0,c=[],d=t();for(let t=0;t<d.length;t++){let i=r(d[t]);("lu".includes(a)||0===Object.keys(e).length||s.Query(i,e))&&(i=s.Update(i,n),l(i,d[t]),u++,o.ReturnDocuments&&c.push(i))}o.ReturnDocuments?i(c):i(u)}catch(e){a(e)}}))},d.ReplaceOne=async function(e,n,o){return new Promise((async(i,a)=>{try{if("o"!==s.ShortType(o)&&(o={}),"o"!==s.ShortType(n))throw new Error("Document must be an object.");if("u"===s.ShortType(n._id))throw new Error("Document must contain an _id field.");let a=0,u=null,c=t();for(let t=0;t<c.length;t++){let o=r(c[t]);if(s.Query(o,e)){u=s.Clone(n),l(u,c[t]),a++;break}}o.ReturnDocuments?i(u):i(a)}catch(e){a(e)}}))},d.DeleteOne=async function(e,n){return new Promise((async(o,i)=>{try{"o"!==s.ShortType(n)&&(n={});let i=s.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=null,l=t();if("lu".includes(i)||0===Object.keys(e).length)l.length>0&&(u=r(l[0]),c(l[0]),a++);else for(let t=0;t<l.length;t++){let n=r(l[t]);if(s.Query(n,e)){u=n,c(l[t]),a++;break}}n.ReturnDocuments?o(u):o(a)}catch(e){i(e)}}))},d.DeleteMany=async function(e,n){return new Promise((async(o,i)=>{try{"o"!==s.ShortType(n)&&(n={});let i=s.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=[],l=t();for(let t=0;t<l.length;t++){let o=r(l[t]);("lu".includes(i)||0===Object.keys(e).length||s.Query(o,e))&&(c(l[t]),a++,n.ReturnDocuments&&u.push(o))}n.ReturnDocuments?o(u):o(a)}catch(e){i(e)}}))},d}}},337:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(632)(),s=r(212),a=r(54);e.exports={AdapterName:"jsonstor-jsonfile",AdapterDescription:"Documents are cached in memory and persisted to a single json file.",GetAdapter:function(e){if("o"!==i.ShortType(e))throw new Error("This adapter requires a Settings parameter.");if("s"!==i.ShortType(e.Path))throw new Error("This adapter requires a Settings.Path parameter.");"b"!==i.ShortType(e.AutoFlush)&&(e.AutoFlush=!0);let t=s(this,e);function r(){let r=o.dirname(e.Path);n.existsSync(r)||n.mkdirSync(r,{recursive:!0});let i=JSON.stringify(t.MemoryStorage.store);n.writeFileSync(e.Path,i,"utf8")}return t.MemoryStorage=a.GetAdapter(e),function(){if(t.MemoryStorage.store=[],!n.existsSync(e.Path))return;let r=n.readFileSync(e.Path,"utf8");t.MemoryStorage.store=JSON.parse(r)}(),t.DropStorage=async function(r){return new Promise((async(r,o)=>{try{return t.MemoryStorage.store=[],n.existsSync(e.Path)&&n.unlinkSync(e.Path),void r(!0)}catch(e){return void o(e)}}))},t.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return r(),void e(!0)}catch(e){return void t(e)}}))},t.Count=async function(e,r){return await t.MemoryStorage.Count(e,r)},t.InsertOne=async function(n,o){let i=await t.MemoryStorage.InsertOne(n,o);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),i},t.InsertMany=async function(n,o){let i=await t.MemoryStorage.InsertMany(n,o);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),i},t.FindOne=async function(e,r,n){return await t.MemoryStorage.FindOne(e,r,n)},t.FindMany=async function(e,r,n){return await t.MemoryStorage.FindMany(e,r,n)},t.UpdateOne=async function(n,o,i){let s=await t.MemoryStorage.UpdateOne(n,o,i);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),s},t.UpdateMany=async function(n,o,i){let s=await t.MemoryStorage.UpdateMany(n,o,i);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),s},t.ReplaceOne=async function(n,o,i){let s=await t.MemoryStorage.ReplaceOne(n,o,i);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),s},t.DeleteOne=async function(n,o){let i=await t.MemoryStorage.DeleteOne(n,o);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),i},t.DeleteMany=async function(n,o){let i=await t.MemoryStorage.DeleteMany(n,o);return t.MemoryStorage.is_dirty&&(e.AutoFlush&&r(),t.MemoryStorage.is_dirty=!1),i},t}}},54:(e,t,r)=>{"use strict";const n=r(828),o=r(632)(),i=r(212);e.exports={AdapterName:"jsonstor-memory",AdapterDescription:"Documents are stored in memory and are not persisted to disk.",GetAdapter:function(e){let t=i(this,e);return t.store=[],t.is_dirty=!1,t.DropStorage=async function(e){return new Promise((async(e,r)=>{try{return t.store=[],void e(!0)}catch(e){return void r(e)}}))},t.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return void e(!0)}catch(e){return void t(e)}}))},t.Count=async function(e,r){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(r)&&(r={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0;if("lu".includes(i)||0===Object.keys(e).length)s=t.store.length;else for(let r=0;r<t.store.length;r++){let n=t.store[r];o.Query(n,e)&&s++}n(s)}catch(e){i(e)}}))},t.InsertOne=async function(e,r){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(r)&&(r={}),"o"!==o.ShortType(e))throw new Error("Document must be an object.");let s=o.Clone(e);void 0===s._id&&(s._id=n.v4()),t.store.push(s),t.is_dirty=!0,r.ReturnDocuments?i(s):i(1)}catch(e){s(e)}}))},t.InsertMany=async function(e,r){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(r)&&(r={}),"a"!==o.ShortType(e))throw new Error("Documents must be an array of objects.");let s=0,a=[];for(let i=0;i<e.length;i++){let u=o.Clone(e[i]);void 0===u._id&&(u._id=n.v4()),t.store.push(u),s++,r.ReturnDocuments&&a.push(u),t.is_dirty=!0}r.ReturnDocuments?i(a):i(s)}catch(e){s(e)}}))},t.FindOne=async function(e,r,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=null;if("lu".includes(s)||0===Object.keys(e).length)t.store.length>0&&(a=t.store[0],a=o.Project(a,r));else for(let n=0;n<t.store.length;n++){let i=t.store[n];if(o.Query(i,e)){a=o.Project(i,r);break}}i(a)}catch(e){s(e)}}))},t.FindMany=async function(e,r,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=[];for(let n=0;n<t.store.length;n++){let i=t.store[n];("lu".includes(s)||0===Object.keys(e).length||o.Query(i,e))&&(i=o.Project(i,r),a.push(i))}i(a)}catch(e){s(e)}}))},t.UpdateOne=async function(e,r,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=null;if("lu".includes(s)||0===Object.keys(e).length)t.store.length>0&&(u=t.store[0],u=o.Update(u,r),t.store[0]=u,a++,t.is_dirty=!0);else for(let n=0;n<t.store.length;n++){let i=t.store[n];if(o.Query(i,e)){u=o.Update(i,r),t.store[n]=u,a++,t.is_dirty=!0;break}}n.ReturnDocuments?i(u):i(a)}catch(e){s(e)}}))},t.UpdateMany=async function(e,r,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=[];for(let i=0;i<t.store.length;i++){let l=t.store[i];("lu".includes(s)||0===Object.keys(e).length||o.Query(l,e))&&(l=o.Update(l,r),t.store[i]=l,a++,n.ReturnDocuments&&u.push(l),t.is_dirty=!0)}n.ReturnDocuments?i(u):i(a)}catch(e){s(e)}}))},t.ReplaceOne=async function(e,r,n){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(n)&&(n={}),"o"!==o.ShortType(e))throw new Error("Criteria must be an object.");if("o"!==o.ShortType(r))throw new Error("Document must be an object.");let s=0,a=null;for(let n=0;n<t.store.length;n++){let i=t.store[n];if(o.Query(i,e)){a=o.Clone(r),t.store[n]=a,s++,t.is_dirty=!0;break}}n.ReturnDocuments?i(a):i(s)}catch(e){s(e)}}))},t.DeleteOne=async function(e,r){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(r)&&(r={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0,a=null;if("lu".includes(i)||0===Object.keys(e).length)t.store.length>0&&(a=t.store[0],t.store.splice(0,1),s++,t.is_dirty=!0);else for(let r=0;r<t.store.length;r++){let n=t.store[r];if(o.Query(n,e)){a=n,t.store.splice(r,1),s++,t.is_dirty=!0;break}}r.ReturnDocuments?n(a):n(s)}catch(e){i(e)}}))},t.DeleteMany=async function(e,r){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(r)&&(r={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0,a=[];for(let n=0;n<t.store.length;){let u=t.store[n];"lu".includes(i)||0===Object.keys(e).length||o.Query(u,e)?(t.store.splice(n,1),s++,r.ReturnDocuments&&a.push(u),t.is_dirty=!0):n++}r.ReturnDocuments?n(a):n(s)}catch(e){i(e)}}))},t}}},121:(e,t,r)=>{"use strict";r(147);const n=r(632)(),o=r(212);e.exports={FilterName:"jsonstor-oplog",FilterDescription:"Traces storage function calls and outputs messages to console, file, or other log targets.",GetFilter:function(e,t){if("o"!==n.ShortType(e))throw new Error("jsonstor-oplog requires a Storage object parameter.");"o"!==n.ShortType(t)&&(t={}),"f"!==n.ShortType(t.LogTo)&&(t.LogTo=console.log),"f"!==n.ShortType(t.ErrorTo)&&(t.ErrorTo=console.error),"b"!==n.ShortType(t.IncludeTimestamp)&&(t.IncludeTimestamp=!0),"b"!==n.ShortType(t.IncludeDuration)&&(t.IncludeDuration=!0),"s"!==n.ShortType(t.DurationUnits)&&(t.DurationUnits="ms"),"b"!==n.ShortType(t.IncludePluginName)&&(t.IncludePluginName=!0),"b"!==n.ShortType(t.IncludeParameters)&&(t.IncludeParameters=!0);let r=o(null,t);async function i(r,o,i){return new Promise((async(s,a)=>{try{t.LogTo("");let u=null;u=void 0!==e.AdapterName?e.AdapterName:void 0!==e.FilterName?e.FilterName:"unknown plugin";let l=(new Date).toISOString(),c=null;c=BigInt?process.hrtime.bigint():process.hrtime();let d=await e[r](...i),y=null;if(BigInt){let p=process.hrtime.bigint();y=Number(p-c),y/=1e6}else y=process.hrtime(c);let h="=== ";function f(e,r){h=`    ${e} : `;let o=n.ShortType(r);"bns".includes(o)?h+=`${r}`:h+="o"===o?`${JSON.stringify(r)}`:"a"===o?`${r.length} items`:"l"===o?"null":"u"===o?"undefined":`unknown type [${o}]`,t.LogTo&&t.LogTo(h)}if(t.IncludeTimestamp&&(h+=`${l} | `),t.IncludeDuration&&("s"===t.DurationUnits?h+=`${(y/1e3).toFixed(3)} s | `:"ms"===t.DurationUnits?h+=`${y.toFixed(3)} ms | `:"ns"===t.DurationUnits&&(h+=1e6*y+" ns | ")),t.IncludePluginName&&(h+=`${u} | `),h+=`${r}`,h+=" ===",t.LogTo&&t.LogTo(h),t.IncludeParameters)for(let w=0;w<o.length;w++)f(o[w],i[w]);return f("Results",d),void s(d)}catch(m){return t.ErrorTo&&t.ErrorTo(`Error: ${m.message}`),void a(m)}}))}return r.Storage=e,r.DropStorage=async function(e){return await i("DropStorage",["Options"],[e])},r.FlushStorage=async function(e){return await i("FlushStorage",["Options"],[e])},r.Count=async function(e,t){return await i("Count",["Criteria","Options"],[e,t])},r.InsertOne=async function(e,t){return await i("InsertOne",["Document","Options"],[e,t])},r.InsertMany=async function(e,t){return await i("InsertMany",["Documents","Options"],[e,t])},r.FindOne=async function(e,t,r){return await i("FindOne",["Criteria","Projection","Options"],[e,t,r])},r.FindMany=async function(e,t,r){return await i("FindMany",["Criteria","Projection","Options"],[e,t,r])},r.UpdateOne=async function(e,t,r){return await i("UpdateOne",["Criteria","Update","Options"],[e,t,r])},r.UpdateMany=async function(e,t,r){return await i("UpdateMany",["Criteria","Update","Options"],[e,t,r])},r.ReplaceOne=async function(e,t,r){return await i("ReplaceOne",["Criteria","Document","Options"],[e,t,r])},r.DeleteOne=async function(e,t){return await i("DeleteOne",["Criteria","Options"],[e,t])},r.DeleteMany=async function(e,t){return await i("DeleteMany",["Criteria","Options"],[e,t])},r}}},976:(e,t,r)=>{"use strict";const n=r(828),o=r(632)(),i=r(212);e.exports={FilterName:"jsonstor-userinfo",FilterDescription:"Adds user ownership and document sharing to an existing storage.",GetFilter:function(e,t){if("o"!==o.ShortType(e))throw new Error("jsonstor-userinfo requires a Storage object parameter.");if("o"!==o.ShortType(t))throw new Error("jsonstor-userinfo requires a Settings object parameter.");"s"!==o.ShortType(t.UserInfoField)&&(t.UserInfoField="userinfo"),"a"!==o.ShortType(t.AdminRoles)&&(t.AdminRoles=["admin","super"]),"b"!==o.ShortType(t.ThrowPermissionErrors)&&(t.ThrowPermissionErrors=!1),"b"!==o.ShortType(t.HideUserInfo)&&(t.HideUserInfo=!1),"b"!==o.ShortType(t.HideDocumentID)&&(t.HideDocumentID=!1);let r=i(null,t);function s(e,t){return new Error(`The required parameter is missing: [${e}] of type [${t}].`)}function a(){return new Error("User does not have read access to this object or the object does not exist.")}function u(){return new Error("User does not have write access to this object.")}function l(){return(new Date).toISOString()}function c(e,t){let r=!1;for(let n=0;n<t.length;n++){let o=t[n];e.includes(o)||(e.push(o),r=!0)}return r}function d(e,t){let r=!1;for(let n=e.length-1;n>=0;n--){let o=e[n];t.includes(o)||(e.splice(n,1),r=!0)}return r}function y(e){if("o"!==o.ShortType(e))throw s("User","object");if("s"!==o.ShortType(e.user_id))throw s("User.user_id","string");return{id:n.v4(),created_at:l(),updated_at:l(),owner_id:e.user_id,readers:[],writers:[],public:!1}}function h(e){return void 0===e&&(e={}),(e=o.Clone(e)).ReturnDocuments=!0,delete e.User,e}function f(e){t.HideUserInfo&&delete e[t.UserInfoField],t.HideDocumentID&&delete e._id}return r.Storage=e,r.Administrator={name:"Storage Administrator",user_id:"admin@storage",user_role:"admin"},r.Supervisor={name:"Storage Supervisor",user_id:"super@storage",user_role:"super"},r.DropStorage=async function(t){return new Promise((async(r,n)=>{try{return void r(await e.DropStorage(h(t)))}catch(e){return void n(e)}}))},r.FlushStorage=async function(t){return new Promise((async(r,n)=>{try{return void r(await e.FlushStorage(h(t)))}catch(e){return void n(e)}}))},r.Count=async function(t,n){return new Promise((async(i,a)=>{try{if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let a=n.User,u=r.User(a).Criteria(t);return void i(await e.Count(u,h(n)))}catch(e){return void a(e)}}))},r.InsertOne=async function(r,n){return new Promise((async(i,a)=>{try{if("o"!==o.ShortType(r))throw s("Document","object");if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let a=y(n.User),u=o.Clone(r);u[t.UserInfoField]=a;let l=await e.InsertOne(u,h(n));return n.ReturnDocuments?(f(l),void i(l)):void i(1)}catch(e){return void a(e)}}))},r.InsertMany=async function(r,n){return new Promise((async(i,a)=>{try{if("a"!==o.ShortType(r))throw s("Documents","array");if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let a=y(n.User),u=[];for(let e=0;e<r.length;e++){let n=o.Clone(r[e]);n[t.UserInfoField]=a,u.push(n)}return u=await e.InsertMany(u,h(n)),n.ReturnDocuments?(u.forEach((e=>f(e))),void i(u)):void i(u.length)}catch(e){return void a(e)}}))},r.FindOne=async function(t,n,i){return new Promise((async(a,u)=>{try{if("o"!==o.ShortType(i))throw s("Options","object");if("o"!==o.ShortType(i.User))throw s("Options.User","object");let u=i.User,l=r.User(u).Criteria(t),c=await e.FindOne(l,n,h(i));return c&&f(c),void a(c)}catch(e){return void u(e)}}))},r.FindMany=async function(t,n,i){return new Promise((async(a,u)=>{try{if("o"!==o.ShortType(i))throw s("Options","object");if("o"!==o.ShortType(i.User))throw s("Options.User","object");let u=i.User,l=r.User(u).Criteria(t),c=await e.FindMany(l,n,h(i));return c.forEach((e=>f(e))),void a(c)}catch(e){return void u(e)}}))},r.UpdateOne=async function(n,i,c){return new Promise((async(d,y)=>{try{if("o"!==o.ShortType(i)&&(i={}),"o"!==o.ShortType(c))throw s("Options","object");if("o"!==o.ShortType(c.User))throw s("Options.User","object");let y=c.User;i.$set||(i.$set={}),i.$set[`${t.UserInfoField}.updated_at`]=l();let p=r.User(y).Criteria(n),w=await e.FindOne(p,null,h(c)),m=null;if(w?r.User(y).CanWrite(w)||(m=u()):m=a(),m){if(t.ThrowPermissionErrors)throw m;return void d(null)}let S=await e.UpdateOne(p,i,h(c));return c.ReturnDocuments?(f(S),void d(S)):void d(1)}catch(e){return void y(e)}}))},r.UpdateMany=async function(n,i,c){return new Promise((async(d,y)=>{try{if("o"!==o.ShortType(i)&&(i={}),"o"!==o.ShortType(c))throw s("Options","object");if("o"!==o.ShortType(c.User))throw s("Options.User","object");let y=c.User;i.$set||(i.$set={}),i.$set[`${t.UserInfoField}.updated_at`]=l();let p=r.User(y).Criteria(n),w=await e.FindMany(p,{_id:1},h(c)),m=[];for(let n=0;n<w.length;n++){let o=w[n]._id,s=await e.FindOne({_id:o},null,h(c)),l=null;if(s?r.User(y).CanWrite(s)||(l=u()):l=a(),l){if(t.ThrowPermissionErrors)throw l}else s=await e.UpdateOne({_id:o},i,h(c)),m.push(s)}return c.ReturnDocuments?(m.forEach((e=>f(e))),void d(m)):void d(m.length)}catch(e){return void y(e)}}))},r.ReplaceOne=async function(n,i,l){return new Promise((async(c,d)=>{try{if("o"!==o.ShortType(i))throw s("Document","object");if("o"!==o.ShortType(l))throw s("Options","object");if("o"!==o.ShortType(l.User))throw s("Options.User","object");let d=l.User,y=r.User(d).Criteria(n),p=h(l),w=await e.FindOne(y,null,p),m=null;if(w?r.User(d).CanWrite(w)||(m=u()):m=a(),m){if(t.ThrowPermissionErrors)throw m;return void c(null)}let S=await e.ReplaceOne(y,i,p);return l.ReturnDocuments?(f(S),void c(S)):void c(1)}catch(e){return void d(e)}}))},r.DeleteOne=async function(n,i){return new Promise((async(l,c)=>{try{if("o"!==o.ShortType(i))throw s("Options","object");if("o"!==o.ShortType(i.User))throw s("Options.User","object");let c=i.User,d=r.User(c).Criteria(n),y=await e.FindOne(d,null,h(i)),p=null;if(y?r.User(c).CanWrite(y)||(p=u()):p=a(),p){if(t.ThrowPermissionErrors)throw p;return void l(null)}let w=await e.DeleteOne(d,h(i));return i.ReturnDocuments?(f(w),void l(w)):void l(1)}catch(e){return void c(e)}}))},r.DeleteMany=async function(n,i){return new Promise((async(l,c)=>{try{if("o"!==o.ShortType(i))throw s("Options","object");if("o"!==o.ShortType(i.User))throw s("Options.User","object");let c=i.User,d=r.User(c).Criteria(n),y=await e.FindMany(d,{_id:1},h(i)),p=[];for(let n=0;n<y.length;n++){let o=y[n]._id,s=await e.FindOne({_id:o},null,h(i)),l=null;if(s&&r.User(c).CanRead(s)?r.User(c).CanWrite(s)||(l=u()):l=a(),l){if(t.ThrowPermissionErrors)throw l}else s=await e.DeleteOne({_id:o},h(i)),p.push(s)}return i.ReturnDocuments?(p.forEach((e=>f(e))),void l(p)):void l(p.length)}catch(e){return void c(e)}}))},r.User=function(r){let n={};if("o"!==o.ShortType(r))throw s("User","object");if("s"!==o.ShortType(r.user_id))throw s("User.user_id","string");if("s"!==o.ShortType(r.user_role))throw s("User.user_role","string");return n.CanShare=function(e){if("o"!==o.ShortType(e))throw s("Document","object");if("o"!==o.ShortType(e[t.UserInfoField]))throw s("UserInfo","object");if("s"!==o.ShortType(e[t.UserInfoField].id))throw s("UserInfo.id","string");if("s"!==o.ShortType(e[t.UserInfoField].owner_id))throw s("UserInfo.owner_id","string");if("a"!==o.ShortType(e[t.UserInfoField].readers))throw s("UserInfo.readers","array");if("a"!==o.ShortType(e[t.UserInfoField].writers))throw s("UserInfo.writers","array");if("b"!==o.ShortType(e[t.UserInfoField].public))throw s("UserInfo.public","boolean");return!!t.AdminRoles.includes(r.user_role)||r.user_id===e[t.UserInfoField].owner_id},n.CanWrite=function(e){return!!n.CanShare(e)||!!e[t.UserInfoField].writers.includes(r.user_id)},n.CanRead=function(e){return!!n.CanWrite(e)||!!e[t.UserInfoField].readers.includes(r.user_id)||!!e[t.UserInfoField].public},n.Criteria=function(e){let n=o.ShortType(e);if(!"olu".includes(n))throw new Error(`Unknown parameter type [${n}] for [Criteria]. Must be an object, null, or undefined.`);"lu".includes(n)&&(e={});let i=o.SafeClone(e,["_id"]);if(!t.AdminRoles.includes(r.user_role)){let e=[];{let n={};n[t.UserInfoField+".owner_id"]=r.user_id,e.push(n)}{let n={};n[t.UserInfoField+".readers"]={$in:[r.user_id]},e.push(n)}{let n={};n[t.UserInfoField+".writers"]={$in:[r.user_id]},e.push(n)}{let r={};r[t.UserInfoField+".public"]=!0,e.push(r)}void 0===i.$or?i.$or=e:(i.$and=[{$or:i.$or},{$or:e}],delete i.$or)}return i},n.SetOwner=async function(r,o){return new Promise((async(i,s)=>{try{let s=n.Criteria(r),a=await e.FindMany(s,null,{ReturnDocuments:!0}),u=[];for(let r=0;r<a.length;r++){let i=a[r];n.CanShare(i)&&(i[t.UserInfoField].owner_id=o,i[t.UserInfoField].updated_at=l(),i=await e.ReplaceOne({_id:i._id},i,{ReturnDocuments:!0}),f(i),u.push(i))}return void i(u)}catch(e){return void s(e)}}))},n.Share=async function(r,i,s,a){return new Promise((async(u,d)=>{try{if("lu".includes(o.ShortType(i))&&(i=[]),"s"===o.ShortType(i)&&(i=[i]),"a"!==o.ShortType(i))throw new Error("Readers must be a string or an array of strings.");if("lu".includes(o.ShortType(s))&&(s=[]),"s"===o.ShortType(s)&&(s=[s]),"a"!==o.ShortType(s))throw new Error("Writers must be a string or an array of strings.");let d=n.Criteria(r),y=[],h=l(),p=await e.FindMany(d,null,{ReturnDocuments:!0});for(let r=0;r<p.length;r++){let u=p[r];if(!n.CanShare(u))continue;let l=!1;i.length&&c(u[t.UserInfoField].readers,i)&&(l=!0),s.length&&c(u[t.UserInfoField].writers,s)&&(l=!0),a&&!u[t.UserInfoField].public&&"b"===o.ShortType(a)&&(u[t.UserInfoField].public=!0,l=!0),l&&(u[t.UserInfoField].updated_at=h,u=await e.ReplaceOne({_id:u._id},u,{ReturnDocuments:!0}),f(u),y.push(u))}return void u(y)}catch(e){return void d(e)}}))},n.SetSharing=async function(r,o,i,s){return new Promise((async(o,i)=>{try{Readers=Readers||[],Writers=Writers||[];let i=n.Criteria(r),s=[],a=l(),u=await e.FindMany(i,null,{ReturnDocuments:!0});for(let r=0;r<u.length;r++){let o=u[r];n.CanShare(o)&&(o[t.UserInfoField].readers=Readers,o[t.UserInfoField].writers=Writers,o[t.UserInfoField].public=!!MakePublic,o[t.UserInfoField].updated_at=a,o=await e.ReplaceOne({_id:o._id},o,{ReturnDocuments:!0}),f(o),s.push(o))}return void o(s)}catch(e){return void i(e)}}))},n.UnsetSharing=async function(r,i,s,a){return new Promise((async(u,c)=>{try{if("lu".includes(o.ShortType(i))&&(i=[]),"s"===o.ShortType(i)&&(i=[i]),"a"!==o.ShortType(i))throw new Error("UnsetReaders must be a string or an array of strings.");if("lu".includes(o.ShortType(s))&&(s=[]),"s"===o.ShortType(s)&&(s=[s]),"a"!==o.ShortType(s))throw new Error("UnsetWriters must be a string or an array of strings.");let c=n.Criteria(r),y=[],h=l(),p=await e.FindMany(c,null,{ReturnDocuments:!0});for(let r=0;r<p.length;r++){let u=p[r];n.CanShare(u)||continuel;let l=!1;i.length&&d(u[t.UserInfoField].readers,i)&&(l=!0),s.length&&d(u[t.UserInfoField].writers,s)&&(l=!0),a&&u[t.UserInfoField].public&&"b"===o.ShortType(a)&&(u[t.UserInfoField].public=!1,l=!0),l&&(u[t.UserInfoField].updated_at=h,u=await e.ReplaceOne(u),f(u),y.push(u))}return void u(y)}catch(e){return void c(e)}}))},n},r}}},212:e=>{"use strict";e.exports=function(e,t){return{Adapter:e,Settings:t,DropStorage:async function(e){throw new Error("DropStorage is not implemeted.")},FlushStorage:async function(e){throw new Error("FlushStorage is not implemeted.")},Count:async function(e,t){throw new Error("Count is not implemeted.")},InsertOne:async function(e,t){throw new Error("InsertOne is not implemeted.")},InsertMany:async function(e,t){throw new Error("InsertMany is not implemeted.")},FindOne:async function(e,t,r){throw new Error("FindOne is not implemeted.")},FindMany:async function(e,t,r){throw new Error("FindMany is not implemeted.")},UpdateOne:async function(e,t,r){throw new Error("UpdateOne is not implemeted.")},UpdateMany:async function(e,t,r){throw new Error("UpdateMany is not implemeted.")},ReplaceOne:async function(e,t,r){throw new Error("ReplaceOne is not implemeted.")},DeleteOne:async function(e,t){throw new Error("DeleteOne is not implemeted.")},DeleteMany:async function(e,t){throw new Error("DeleteMany is not implemeted.")}}}},249:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(632)();e.exports=function(e,t,s){let a={Adapters:{},Filters:{},LoadPlugin:function(e){if("o"===i.ShortType(e))if(e.AdapterName){if(void 0!==a.Adapters[e.AdapterName])throw new Error(`Storage adapter [${e.AdapterName}] already exists.`);a.Adapters[e.AdapterName]=e}else{if(!e.FilterName)return null;if(void 0!==a.Filters[e.FilterName])throw new Error(`Storage filter [${e.FilterName}] already exists.`);a.Filters[e.FilterName]=e}return e},LoadPlugins:function(e,t){if(!n.existsSync(e))throw new Error(`The path [${e}] does not exist.`);let i=n.readdirSync(e,{withFileTypes:!0});for(let n=0;n<i.length;n++){let s=i[n];if(s.isDirectory()&&t)a.LoadPlugins(o.join(e,s.name),!0);else if(s.isFile())try{let t=o.join(e,s.name);a.LoadPlugin(r(875)(t))}catch(e){console.error(e)}}},GetStorage:function(e,t,r){if(!"olu".includes(i.ShortType(t)))throw new Error("The Settings parameter must be an object, null, or undefined.");if("lu".includes(i.ShortType(t))&&(t={}),void 0===a.Adapters[e])throw new Error(`Storage adapter [${e}] is not loaded.`);let n=a.Adapters[e].GetAdapter(t);if(n.AdapterName=e,Array.isArray(r))for(let e=0;e<r.length;e++){let t=r[e];if("o"!==i.ShortType(t))throw new Error("The Filters parameter must be an array of filter entries: { FilterName: '...', Settings: {...} }.");if(void 0===t.FilterName)throw new Error("The FilterName field is required.");if(void 0===a.Filters[t.FilterName])throw new Error(`Storage filter [${t.FilterName}] is not loaded.`);n=a.Filters[t.FilterName].GetFilter(n,t.Settings),n.FilterName=t.FilterName}return n}};return a.LoadPlugin(r(54)),a.LoadPlugin(r(337)),a.LoadPlugin(r(514)),a.LoadPlugin(r(121)),a.LoadPlugin(r(976)),"string"==typeof e?a.GetStorage(e,t,s):a}},875:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=875,e.exports=t},632:e=>{"use strict";e.exports=require("@liquicode/jsongin")},828:e=>{"use strict";e.exports=require("uuid")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}return r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r(249)})()));