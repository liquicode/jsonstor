!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jsonstor=t():e.jsonstor=t()}("undefined"!=typeof self?self:this,(()=>(()=>{var e={514:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(828),s=r(632)();e.exports={AdapterName:"jsonstor-folder",AdapterDescription:"Each document is stored in its own file in a single folder.",GetAdapter:function(e,t){if("o"!==s.ShortType(t))throw new Error("This adapter requires a Settings parameter.");if("s"!==s.ShortType(t.Path))throw new Error("This adapter requires a Settings.Path string parameter.");let r=e.StorageInterface();function a(){if(!n.existsSync(t.Path))return[];let e=n.readdirSync(t.Path);return e=e.filter((e=>".json"===o.extname(e).toLowerCase())),e}function u(e){let r=o.join(t.Path,e);if(!n.existsSync(r))return null;let i=n.readFileSync(r,"utf8");return JSON.parse(i)}function l(e){n.existsSync(t.Path)||n.mkdirSync(t.Path,{recursive:!0});let r=process.hrtime(),i=o.join(t.Path,`${(new Date).getTime()}.${r[0]}.${r[1]}.json`),s=JSON.stringify(e);n.writeFileSync(i,s,"utf8")}function c(e,r){if(!n.existsSync(t.Path))return;let i=o.join(t.Path,r),s=JSON.stringify(e);n.writeFileSync(i,s,"utf8")}function d(e){if(!n.existsSync(t.Path))return;let r=o.join(t.Path,e);n.existsSync(r)&&n.unlinkSync(r)}return r.Settings=t,r.DropStorage=async function(e){return new Promise((async(e,r)=>{try{return n.existsSync(t.Path)&&n.rmdirSync(t.Path,{recursive:!0,force:!0}),void e(!0)}catch(e){return void r(e)}}))},r.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return void e(!0)}catch(e){return void t(e)}}))},r.Count=async function(e,t){return new Promise((async(r,n)=>{try{"o"!==s.ShortType(t)&&(t={});let n=s.ShortType(e);if(!"olu".includes(n))throw new Error("Criteria must be an object, null, or undefined.");let o=0,i=a();if("lu".includes(n)||0===Object.keys(e).length)o=i.length;else for(let t=0;t<i.length;t++){let r=u(i[t]);s.Query(r,e)&&o++}r(o)}catch(e){n(e)}}))},r.InsertOne=async function(e,t){return new Promise((async(r,n)=>{try{if("o"!==s.ShortType(t)&&(t={}),"o"!==s.ShortType(e))throw new Error("Document must be an object.");let n=s.Clone(e);void 0===n._id&&(n._id=i.v4()),l(n),t.ReturnDocuments?r(n):r(1)}catch(e){n(e)}}))},r.InsertMany=async function(e,t){return new Promise((async(r,n)=>{try{if("o"!==s.ShortType(t)&&(t={}),"a"!==s.ShortType(e))throw new Error("Documents must be an array of objects.");let n=0,o=[];for(let r=0;r<e.length;r++){let a=e[r];a=s.Clone(a),void 0===a._id&&(a._id=i.v4()),l(a),n++,t.ReturnDocuments&&o.push(a)}t.ReturnDocuments?r(o):r(n)}catch(e){n(e)}}))},r.FindOne=async function(e,t,r){return new Promise((async(n,o)=>{try{"o"!==s.ShortType(r)&&(r={});let o=s.ShortType(e);if(!"olu".includes(o))throw new Error("Criteria must be an object, null, or undefined.");let i=null,l=a();if("lu".includes(o)||0===Object.keys(e).length)l.length>0&&(i=u(l[0]),i=s.Project(i,t));else for(let r=0;r<l.length;r++){let n=u(l[r]);if(s.Query(n,e)){i=s.Project(n,t);break}}n(i)}catch(e){o(e)}}))},r.FindMany=async function(e,t,r){return new Promise((async(n,o)=>{try{"o"!==s.ShortType(r)&&(r={});let o=s.ShortType(e);if(!"olu".includes(o))throw new Error("Criteria must be an object, null, or undefined.");let i=[],l=a();for(let r=0;r<l.length;r++){let n=u(l[r]);("lu".includes(o)||0===Object.keys(e).length||s.Query(n,e))&&(n=s.Project(n,t),i.push(n))}n(i)}catch(e){o(e)}}))},r.UpdateOne=async function(e,t,r){return new Promise((async(n,o)=>{try{"o"!==s.ShortType(r)&&(r={});let o=s.ShortType(e);if(!"olu".includes(o))throw new Error("Criteria must be an object, null, or undefined.");let i=0,l=null,d=a();if("lu".includes(o)||0===Object.keys(e).length)d.length>0&&(l=u(d[0]),l=s.Update(l,t),c(l,d[0]),i++);else for(let r=0;r<d.length;r++){let n=u(d[r]);if(s.Query(n,e)){l=s.Update(n,t),c(l,d[r]),i++;break}}r.ReturnDocuments?n(l):n(i)}catch(e){o(e)}}))},r.UpdateMany=async function(e,t,r){return new Promise((async(n,o)=>{try{"o"!==s.ShortType(r)&&(r={});let o=s.ShortType(e);if(!"olu".includes(o))throw new Error("Criteria must be an object, null, or undefined.");let i=0,l=[],d=a();for(let n=0;n<d.length;n++){let a=u(d[n]);("lu".includes(o)||0===Object.keys(e).length||s.Query(a,e))&&(a=s.Update(a,t),c(a,d[n]),i++,r.ReturnDocuments&&l.push(a))}r.ReturnDocuments?n(l):n(i)}catch(e){o(e)}}))},r.ReplaceOne=async function(e,t,r){return new Promise((async(n,o)=>{try{if("o"!==s.ShortType(r)&&(r={}),"o"!==s.ShortType(t))throw new Error("Document must be an object.");if("u"===s.ShortType(t._id))throw new Error("Document must contain an _id field.");let o=0,i=null,l=a();for(let r=0;r<l.length;r++){let n=u(l[r]);if(s.Query(n,e)){i=s.Clone(t),c(i,l[r]),o++;break}}r.ReturnDocuments?n(i):n(o)}catch(e){o(e)}}))},r.DeleteOne=async function(e,t){return new Promise((async(r,n)=>{try{"o"!==s.ShortType(t)&&(t={});let n=s.ShortType(e);if(!"olu".includes(n))throw new Error("Criteria must be an object, null, or undefined.");let o=0,i=null,l=a();if("lu".includes(n)||0===Object.keys(e).length)l.length>0&&(i=u(l[0]),d(l[0]),o++);else for(let t=0;t<l.length;t++){let r=u(l[t]);if(s.Query(r,e)){i=r,d(l[t]),o++;break}}t.ReturnDocuments?r(i):r(o)}catch(e){n(e)}}))},r.DeleteMany=async function(e,t){return new Promise((async(r,n)=>{try{"o"!==s.ShortType(t)&&(t={});let n=s.ShortType(e);if(!"olu".includes(n))throw new Error("Criteria must be an object, null, or undefined.");let o=0,i=[],l=a();for(let r=0;r<l.length;r++){let a=u(l[r]);("lu".includes(n)||0===Object.keys(e).length||s.Query(a,e))&&(d(l[r]),o++,t.ReturnDocuments&&i.push(a))}t.ReturnDocuments?r(i):r(o)}catch(e){n(e)}}))},r}}},337:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(632)(),s=r(54);e.exports={AdapterName:"jsonstor-jsonfile",AdapterDescription:"Documents are cached in memory and persisted to a single json file.",GetAdapter:function(e,t){if("o"!==i.ShortType(t))throw new Error("This adapter requires a Settings parameter.");if("s"!==i.ShortType(t.Path))throw new Error("This adapter requires a Settings.Path parameter.");"b"!==i.ShortType(t.AutoFlush)&&(t.AutoFlush=!0);let r=e.StorageInterface();function a(){let e=o.dirname(t.Path);n.existsSync(e)||n.mkdirSync(e,{recursive:!0});let i=JSON.stringify(r.MemoryStorage.store);n.writeFileSync(t.Path,i,"utf8")}return r.Settings=t,r.MemoryStorage=s.GetAdapter(e,t),function(){if(r.MemoryStorage.store=[],!n.existsSync(t.Path))return;let e=n.readFileSync(t.Path,"utf8");r.MemoryStorage.store=JSON.parse(e)}(),r.DropStorage=async function(e){return new Promise((async(e,o)=>{try{return r.MemoryStorage.store=[],n.existsSync(t.Path)&&n.unlinkSync(t.Path),void e(!0)}catch(e){return void o(e)}}))},r.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return a(),void e(!0)}catch(e){return void t(e)}}))},r.Count=async function(e,t){return await r.MemoryStorage.Count(e,t)},r.InsertOne=async function(e,n){let o=await r.MemoryStorage.InsertOne(e,n);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),o},r.InsertMany=async function(e,n){let o=await r.MemoryStorage.InsertMany(e,n);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),o},r.FindOne=async function(e,t,n){return await r.MemoryStorage.FindOne(e,t,n)},r.FindMany=async function(e,t,n){return await r.MemoryStorage.FindMany(e,t,n)},r.UpdateOne=async function(e,n,o){let i=await r.MemoryStorage.UpdateOne(e,n,o);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),i},r.UpdateMany=async function(e,n,o){let i=await r.MemoryStorage.UpdateMany(e,n,o);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),i},r.ReplaceOne=async function(e,n,o){let i=await r.MemoryStorage.ReplaceOne(e,n,o);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),i},r.DeleteOne=async function(e,n){let o=await r.MemoryStorage.DeleteOne(e,n);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),o},r.DeleteMany=async function(e,n){let o=await r.MemoryStorage.DeleteMany(e,n);return r.MemoryStorage.is_dirty&&(t.AutoFlush&&a(),r.MemoryStorage.is_dirty=!1),o},r}}},54:(e,t,r)=>{"use strict";const n=r(828),o=r(632)();e.exports={AdapterName:"jsonstor-memory",AdapterDescription:"Documents are stored in memory and are not persisted to disk.",GetAdapter:function(e,t){let r=e.StorageInterface();return r.Settings=t,r.store=[],r.is_dirty=!1,r.DropStorage=async function(e){return new Promise((async(e,t)=>{try{return r.store=[],void e(!0)}catch(e){return void t(e)}}))},r.FlushStorage=async function(e){return new Promise((async(e,t)=>{try{return void e(!0)}catch(e){return void t(e)}}))},r.Count=async function(e,t){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(t)&&(t={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0;if("lu".includes(i)||0===Object.keys(e).length)s=r.store.length;else for(let t=0;t<r.store.length;t++){let n=r.store[t];o.Query(n,e)&&s++}n(s)}catch(e){i(e)}}))},r.InsertOne=async function(e,t){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(t)&&(t={}),"o"!==o.ShortType(e))throw new Error("Document must be an object.");let s=o.Clone(e);void 0===s._id&&(s._id=n.v4()),r.store.push(s),r.is_dirty=!0,t.ReturnDocuments?i(s):i(1)}catch(e){s(e)}}))},r.InsertMany=async function(e,t){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(t)&&(t={}),"a"!==o.ShortType(e))throw new Error("Documents must be an array of objects.");let s=0,a=[];for(let i=0;i<e.length;i++){let u=o.Clone(e[i]);void 0===u._id&&(u._id=n.v4()),r.store.push(u),s++,t.ReturnDocuments&&a.push(u),r.is_dirty=!0}t.ReturnDocuments?i(a):i(s)}catch(e){s(e)}}))},r.FindOne=async function(e,t,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=null;if("lu".includes(s)||0===Object.keys(e).length)r.store.length>0&&(a=r.store[0],a=o.Project(a,t));else for(let n=0;n<r.store.length;n++){let i=r.store[n];if(o.Query(i,e)){a=o.Project(i,t);break}}i(a)}catch(e){s(e)}}))},r.FindMany=async function(e,t,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=[];for(let n=0;n<r.store.length;n++){let i=r.store[n];("lu".includes(s)||0===Object.keys(e).length||o.Query(i,e))&&(i=o.Project(i,t),a.push(i))}i(a)}catch(e){s(e)}}))},r.UpdateOne=async function(e,t,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=null;if("lu".includes(s)||0===Object.keys(e).length)r.store.length>0&&(u=r.store[0],u=o.Update(u,t),r.store[0]=u,a++,r.is_dirty=!0);else for(let n=0;n<r.store.length;n++){let i=r.store[n];if(o.Query(i,e)){u=o.Update(i,t),r.store[n]=u,a++,r.is_dirty=!0;break}}n.ReturnDocuments?i(u):i(a)}catch(e){s(e)}}))},r.UpdateMany=async function(e,t,n){return new Promise((async(i,s)=>{try{"o"!==o.ShortType(n)&&(n={});let s=o.ShortType(e);if(!"olu".includes(s))throw new Error("Criteria must be an object, null, or undefined.");let a=0,u=[];for(let i=0;i<r.store.length;i++){let l=r.store[i];("lu".includes(s)||0===Object.keys(e).length||o.Query(l,e))&&(l=o.Update(l,t),r.store[i]=l,a++,n.ReturnDocuments&&u.push(l),r.is_dirty=!0)}n.ReturnDocuments?i(u):i(a)}catch(e){s(e)}}))},r.ReplaceOne=async function(e,t,n){return new Promise((async(i,s)=>{try{if("o"!==o.ShortType(n)&&(n={}),"o"!==o.ShortType(e))throw new Error("Criteria must be an object.");if("o"!==o.ShortType(t))throw new Error("Document must be an object.");let s=0,a=null;for(let n=0;n<r.store.length;n++){let i=r.store[n];if(o.Query(i,e)){a=o.Clone(t),r.store[n]=a,s++,r.is_dirty=!0;break}}n.ReturnDocuments?i(a):i(s)}catch(e){s(e)}}))},r.DeleteOne=async function(e,t){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(t)&&(t={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0,a=null;if("lu".includes(i)||0===Object.keys(e).length)r.store.length>0&&(a=r.store[0],r.store.splice(0,1),s++,r.is_dirty=!0);else for(let t=0;t<r.store.length;t++){let n=r.store[t];if(o.Query(n,e)){a=n,r.store.splice(t,1),s++,r.is_dirty=!0;break}}t.ReturnDocuments?n(a):n(s)}catch(e){i(e)}}))},r.DeleteMany=async function(e,t){return new Promise((async(n,i)=>{try{"o"!==o.ShortType(t)&&(t={});let i=o.ShortType(e);if(!"olu".includes(i))throw new Error("Criteria must be an object, null, or undefined.");let s=0,a=[];for(let n=0;n<r.store.length;){let u=r.store[n];"lu".includes(i)||0===Object.keys(e).length||o.Query(u,e)?(r.store.splice(n,1),s++,t.ReturnDocuments&&a.push(u),r.is_dirty=!0):n++}t.ReturnDocuments?n(a):n(s)}catch(e){i(e)}}))},r}}},121:(e,t,r)=>{"use strict";r(147);const n=r(632)();e.exports={FilterName:"jsonstor-oplog",FilterDescription:"Traces storage function calls and outputs messages to console, file, or other log targets.",GetFilter:function(e,t,r){if("o"!==n.ShortType(t))throw new Error("jsonstor-oplog requires a Storage object parameter.");"o"!==n.ShortType(r)&&(r={}),"f"!==n.ShortType(r.LogTo)&&(r.LogTo=console.log),"f"!==n.ShortType(r.ErrorTo)&&(r.ErrorTo=console.error),"b"!==n.ShortType(r.IncludeTimestamp)&&(r.IncludeTimestamp=!0),"b"!==n.ShortType(r.IncludeDuration)&&(r.IncludeDuration=!0),"s"!==n.ShortType(r.DurationUnits)&&(r.DurationUnits="ms"),"b"!==n.ShortType(r.IncludePluginName)&&(r.IncludePluginName=!0),"b"!==n.ShortType(r.IncludeParameters)&&(r.IncludeParameters=!0);let o=e.StorageInterface();async function i(e,o,i){return new Promise((async(s,a)=>{try{r.LogTo("");let u=null;u=void 0!==t.AdapterName?t.AdapterName:void 0!==t.FilterName?t.FilterName:"unknown plugin";let l=(new Date).toISOString(),c=null;c=BigInt?process.hrtime.bigint():process.hrtime();let d=await t[e](...i),y=null;if(BigInt){let p=process.hrtime.bigint();y=Number(p-c),y/=1e6}else y=process.hrtime(c);let h="=== ";function f(e,t){h=`    ${e} : `;let o=n.ShortType(t);"bns".includes(o)?h+=`${t}`:h+="o"===o?`${JSON.stringify(t)}`:"a"===o?`${t.length} items`:"l"===o?"null":"u"===o?"undefined":`unknown type [${o}]`,r.LogTo&&r.LogTo(h)}if(r.IncludeTimestamp&&(h+=`${l} | `),r.IncludeDuration&&("s"===r.DurationUnits?h+=`${(y/1e3).toFixed(3)} s | `:"ms"===r.DurationUnits?h+=`${y.toFixed(3)} ms | `:"ns"===r.DurationUnits&&(h+=1e6*y+" ns | ")),r.IncludePluginName&&(h+=`${u} | `),h+=`${e}`,h+=" ===",r.LogTo&&r.LogTo(h),r.IncludeParameters)for(let w=0;w<o.length;w++)f(o[w],i[w]);return f("Results",d),void s(d)}catch(S){return r.ErrorTo&&r.ErrorTo(`Error: ${S.message}`),void a(S)}}))}return o.Settings=r,o.Storage=t,o.DropStorage=async function(e){return await i("DropStorage",["Options"],[e])},o.FlushStorage=async function(e){return await i("FlushStorage",["Options"],[e])},o.Count=async function(e,t){return await i("Count",["Criteria","Options"],[e,t])},o.InsertOne=async function(e,t){return await i("InsertOne",["Document","Options"],[e,t])},o.InsertMany=async function(e,t){return await i("InsertMany",["Documents","Options"],[e,t])},o.FindOne=async function(e,t,r){return await i("FindOne",["Criteria","Projection","Options"],[e,t,r])},o.FindMany=async function(e,t,r){return await i("FindMany",["Criteria","Projection","Options"],[e,t,r])},o.UpdateOne=async function(e,t,r){return await i("UpdateOne",["Criteria","Update","Options"],[e,t,r])},o.UpdateMany=async function(e,t,r){return await i("UpdateMany",["Criteria","Update","Options"],[e,t,r])},o.ReplaceOne=async function(e,t,r){return await i("ReplaceOne",["Criteria","Document","Options"],[e,t,r])},o.DeleteOne=async function(e,t){return await i("DeleteOne",["Criteria","Options"],[e,t])},o.DeleteMany=async function(e,t){return await i("DeleteMany",["Criteria","Options"],[e,t])},o}}},976:(e,t,r)=>{"use strict";const n=r(828),o=r(632)();e.exports={FilterName:"jsonstor-userinfo",FilterDescription:"Adds user ownership and document sharing to an existing storage.",GetFilter:function(e,t,r){if("o"!==o.ShortType(t))throw new Error("jsonstor-userinfo requires a Storage object parameter.");if("o"!==o.ShortType(r))throw new Error("jsonstor-userinfo requires a Settings object parameter.");"s"!==o.ShortType(r.UserInfoField)&&(r.UserInfoField="userinfo"),"a"!==o.ShortType(r.AdminRoles)&&(r.AdminRoles=["admin","super"]),"b"!==o.ShortType(r.ThrowPermissionErrors)&&(r.ThrowPermissionErrors=!1),"b"!==o.ShortType(r.HideUserInfo)&&(r.HideUserInfo=!1),"b"!==o.ShortType(r.HideDocumentID)&&(r.HideDocumentID=!1);let i=e.StorageInterface();function s(e,t){return new Error(`The required parameter is missing: [${e}] of type [${t}].`)}function a(){return new Error("User does not have read access to this object or the object does not exist.")}function u(){return new Error("User does not have write access to this object.")}function l(){return(new Date).toISOString()}function c(e,t){let r=!1;for(let n=0;n<t.length;n++){let o=t[n];e.includes(o)||(e.push(o),r=!0)}return r}function d(e,t){let r=!1;for(let n=e.length-1;n>=0;n--){let o=e[n];t.includes(o)||(e.splice(n,1),r=!0)}return r}function y(e){if("o"!==o.ShortType(e))throw s("User","object");if("s"!==o.ShortType(e.user_id))throw s("User.user_id","string");return{id:n.v4(),created_at:l(),updated_at:l(),owner_id:e.user_id,readers:[],writers:[],public:!1}}function h(e){"o"!==o.ShortType(e)&&(e={});let t=JSON.parse(JSON.stringify(e));if(t.ReturnDocuments=!0,"o"!==o.ShortType(t.User))throw s("Options.User","object");return t}function f(e){r.HideUserInfo&&delete e[r.UserInfoField],r.HideDocumentID&&delete e._id}return i.Settings=r,i.Storage=t,i.Administrator={name:"Storage Administrator",user_id:"admin@storage",user_role:"admin"},i.Supervisor={name:"Storage Supervisor",user_id:"super@storage",user_role:"super"},i.DropStorage=async function(e){return new Promise((async(r,n)=>{try{return void r(await t.DropStorage(h(e)))}catch(e){return void n(e)}}))},i.FlushStorage=async function(e){return new Promise((async(r,n)=>{try{return void r(await t.FlushStorage(h(e)))}catch(e){return void n(e)}}))},i.Count=async function(e,r){return new Promise((async(n,a)=>{try{if("o"!==o.ShortType(r))throw s("Options","object");if("o"!==o.ShortType(r.User))throw s("Options.User","object");let a=JSON.parse(JSON.stringify(r));a.ReturnDocuments=!0;let u=i.User(a).Criteria(e);return void n(await t.Count(u,a))}catch(e){return void a(e)}}))},i.InsertOne=async function(e,n){return new Promise((async(i,a)=>{try{if("o"!==o.ShortType(e))throw s("Document","object");if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let a=JSON.parse(JSON.stringify(n));a.ReturnDocuments=!0;let u=y(a.User),l=o.Clone(e);l[r.UserInfoField]=u;let c=await t.InsertOne(l,a);return n.ReturnDocuments?(f(c),void i(c)):void i(1)}catch(e){return void a(e)}}))},i.InsertMany=async function(e,n){return new Promise((async(i,a)=>{try{if("a"!==o.ShortType(e))throw s("Documents","array");if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let a=JSON.parse(JSON.stringify(n));a.ReturnDocuments=!0;let u=y(a.User),l=[];for(let t=0;t<e.length;t++){let n=o.Clone(e[t]);n[r.UserInfoField]=u,l.push(n)}return l=await t.InsertMany(l,a),n.ReturnDocuments?(l.forEach((e=>f(e))),void i(l)):void i(l.length)}catch(e){return void a(e)}}))},i.FindOne=async function(e,r,n){return new Promise((async(a,u)=>{try{if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let u=JSON.parse(JSON.stringify(n));u.ReturnDocuments=!0;let l=i.User(u).Criteria(e),c=await t.FindOne(l,r,u);return c&&f(c),void a(c)}catch(e){return void u(e)}}))},i.FindMany=async function(e,r,n){return new Promise((async(a,u)=>{try{if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let u=JSON.parse(JSON.stringify(n));u.ReturnDocuments=!0;let l=i.User(u).Criteria(e),c=await t.FindMany(l,r,u);return c.forEach((e=>f(e))),void a(c)}catch(e){return void u(e)}}))},i.UpdateOne=async function(e,n,c){return new Promise((async(d,y)=>{try{if("o"!==o.ShortType(n)&&(n={}),"o"!==o.ShortType(c))throw s("Options","object");if("o"!==o.ShortType(c.User))throw s("Options.User","object");let y=JSON.parse(JSON.stringify(c));y.ReturnDocuments=!0,n.$set||(n.$set={}),n.$set[`${r.UserInfoField}.updated_at`]=l();let h=i.User(y).Criteria(e),p=await t.FindOne(h,null,y),w=null;if(p?i.User(y).CanWrite(p)||(w=u()):w=a(),w){if(r.ThrowPermissionErrors)throw w;return void d(null)}let S=await t.UpdateOne(h,n,y);return c.ReturnDocuments?(f(S),void d(S)):void d(1)}catch(e){return void y(e)}}))},i.UpdateMany=async function(e,n,c){return new Promise((async(d,y)=>{try{if("o"!==o.ShortType(n)&&(n={}),"o"!==o.ShortType(c))throw s("Options","object");if("o"!==o.ShortType(c.User))throw s("Options.User","object");let y=JSON.parse(JSON.stringify(c));y.ReturnDocuments=!0,n.$set||(n.$set={}),n.$set[`${r.UserInfoField}.updated_at`]=l();let h=i.User(y).Criteria(e),p=await t.FindMany(h,{_id:1},y),w=[];for(let e=0;e<p.length;e++){let o=p[e]._id,s=await t.FindOne({_id:o},null,y),l=null;if(s?i.User(y).CanWrite(s)||(l=u()):l=a(),l){if(r.ThrowPermissionErrors)throw l}else s=await t.UpdateOne({_id:o},n,y),w.push(s)}return c.ReturnDocuments?(w.forEach((e=>f(e))),void d(w)):void d(w.length)}catch(e){return void y(e)}}))},i.ReplaceOne=async function(e,n,l){return new Promise((async(c,d)=>{try{if("o"!==o.ShortType(n))throw s("Document","object");if("o"!==o.ShortType(l))throw s("Options","object");if("o"!==o.ShortType(l.User))throw s("Options.User","object");let d=JSON.parse(JSON.stringify(l));d.ReturnDocuments=!0;let y=i.User(d).Criteria(e),h=await t.FindOne(y,null,d),p=null;if(h?i.User(d).CanWrite(h)||(p=u()):p=a(),p){if(r.ThrowPermissionErrors)throw p;return void c(null)}let w=await t.ReplaceOne(y,n,d);return l.ReturnDocuments?(f(w),void c(w)):void c(1)}catch(e){return void d(e)}}))},i.DeleteOne=async function(e,n){return new Promise((async(l,c)=>{try{if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let c=JSON.parse(JSON.stringify(n));c.ReturnDocuments=!0;let d=i.User(c).Criteria(e),y=await t.FindOne(d,null,c),h=null;if(y?i.User(c).CanWrite(y)||(h=u()):h=a(),h){if(r.ThrowPermissionErrors)throw h;return void l(null)}let p=await t.DeleteOne(d,c);return n.ReturnDocuments?(f(p),void l(p)):void l(1)}catch(e){return void c(e)}}))},i.DeleteMany=async function(e,n){return new Promise((async(l,c)=>{try{if("o"!==o.ShortType(n))throw s("Options","object");if("o"!==o.ShortType(n.User))throw s("Options.User","object");let c=JSON.parse(JSON.stringify(n));c.ReturnDocuments=!0;let d=i.User(c).Criteria(e),y=await t.FindMany(d,{_id:1},c),h=[];for(let e=0;e<y.length;e++){let n=y[e]._id,o=await t.FindOne({_id:n},null,c),s=null;if(o&&i.User(c).CanRead(o)?i.User(c).CanWrite(o)||(s=u()):s=a(),s){if(r.ThrowPermissionErrors)throw s}else o=await t.DeleteOne({_id:n},c),h.push(o)}return n.ReturnDocuments?(h.forEach((e=>f(e))),void l(h)):void l(h.length)}catch(e){return void c(e)}}))},i.User=function(e){let n={};if("o"!==o.ShortType(e))throw s("UserOptions","object");let i=e.User;if("o"!==o.ShortType(i))throw s("UserOptions.User","object");if("s"!==o.ShortType(i.user_id))throw s("User.user_id","string");if("s"!==o.ShortType(i.user_role))throw s("User.user_role","string");return n.CanShare=function(e){if("o"!==o.ShortType(e))throw s("Document","object");if("o"!==o.ShortType(e[r.UserInfoField]))throw s("UserInfo","object");if("s"!==o.ShortType(e[r.UserInfoField].id))throw s("UserInfo.id","string");if("s"!==o.ShortType(e[r.UserInfoField].owner_id))throw s("UserInfo.owner_id","string");if("a"!==o.ShortType(e[r.UserInfoField].readers))throw s("UserInfo.readers","array");if("a"!==o.ShortType(e[r.UserInfoField].writers))throw s("UserInfo.writers","array");if("b"!==o.ShortType(e[r.UserInfoField].public))throw s("UserInfo.public","boolean");return!!r.AdminRoles.includes(i.user_role)||i.user_id===e[r.UserInfoField].owner_id},n.CanWrite=function(e){return!!n.CanShare(e)||!!e[r.UserInfoField].writers.includes(i.user_id)},n.CanRead=function(e){return!!n.CanWrite(e)||!!e[r.UserInfoField].readers.includes(i.user_id)||!!e[r.UserInfoField].public},n.Criteria=function(e){let t=o.ShortType(e);if(!"olu".includes(t))throw new Error(`Unknown parameter type [${t}] for [Criteria]. Must be an object, null, or undefined.`);"lu".includes(t)&&(e={});let n=o.SafeClone(e,["_id"]);if(!r.AdminRoles.includes(i.user_role)){let e=[];{let t={};t[r.UserInfoField+".owner_id"]=i.user_id,e.push(t)}{let t={};t[r.UserInfoField+".readers"]={$in:[i.user_id]},e.push(t)}{let t={};t[r.UserInfoField+".writers"]={$in:[i.user_id]},e.push(t)}{let t={};t[r.UserInfoField+".public"]=!0,e.push(t)}void 0===n.$or?n.$or=e:(n.$and=[{$or:n.$or},{$or:e}],delete n.$or)}return n},n.SetOwner=async function(o,i){return new Promise((async(s,a)=>{try{let a=n.Criteria(o),u=await t.FindMany(a,null,e),c=[];for(let o=0;o<u.length;o++){let s=u[o];n.CanShare(s)&&(s[r.UserInfoField].owner_id=i,s[r.UserInfoField].updated_at=l(),s=await t.ReplaceOne({_id:s._id},s,e),f(s),c.push(s))}return void s(c)}catch(e){return void a(e)}}))},n.Share=async function(i,s,a,u){return new Promise((async(d,y)=>{try{if("lu".includes(o.ShortType(s))&&(s=[]),"s"===o.ShortType(s)&&(s=[s]),"a"!==o.ShortType(s))throw new Error("Readers must be a string or an array of strings.");if("lu".includes(o.ShortType(a))&&(a=[]),"s"===o.ShortType(a)&&(a=[a]),"a"!==o.ShortType(a))throw new Error("Writers must be a string or an array of strings.");let y=n.Criteria(i),h=[],p=l(),w=await t.FindMany(y,null,e);for(let i=0;i<w.length;i++){let l=w[i];if(!n.CanShare(l))continue;let d=!1;s.length&&c(l[r.UserInfoField].readers,s)&&(d=!0),a.length&&c(l[r.UserInfoField].writers,a)&&(d=!0),u&&!l[r.UserInfoField].public&&"b"===o.ShortType(u)&&(l[r.UserInfoField].public=!0,d=!0),d&&(l[r.UserInfoField].updated_at=p,l=await t.ReplaceOne({_id:l._id},l,e),f(l),h.push(l))}return void d(h)}catch(e){return void y(e)}}))},n.SetSharing=async function(o,i,s,a){return new Promise((async(i,s)=>{try{Readers=Readers||[],Writers=Writers||[];let s=n.Criteria(o),a=[],u=l(),c=await t.FindMany(s,null,e);for(let o=0;o<c.length;o++){let i=c[o];n.CanShare(i)&&(i[r.UserInfoField].readers=Readers,i[r.UserInfoField].writers=Writers,i[r.UserInfoField].public=!!MakePublic,i[r.UserInfoField].updated_at=u,i=await t.ReplaceOne({_id:i._id},i,e),f(i),a.push(i))}return void i(a)}catch(e){return void s(e)}}))},n.UnsetSharing=async function(i,s,a,u){return new Promise((async(c,y)=>{try{if("lu".includes(o.ShortType(s))&&(s=[]),"s"===o.ShortType(s)&&(s=[s]),"a"!==o.ShortType(s))throw new Error("UnsetReaders must be a string or an array of strings.");if("lu".includes(o.ShortType(a))&&(a=[]),"s"===o.ShortType(a)&&(a=[a]),"a"!==o.ShortType(a))throw new Error("UnsetWriters must be a string or an array of strings.");let y=n.Criteria(i),h=[],p=l(),w=await t.FindMany(y,null,e);for(let i=0;i<w.length;i++){let l=w[i];n.CanShare(l)||continuel;let c=!1;s.length&&d(l[r.UserInfoField].readers,s)&&(c=!0),a.length&&d(l[r.UserInfoField].writers,a)&&(c=!0),u&&l[r.UserInfoField].public&&"b"===o.ShortType(u)&&(l[r.UserInfoField].public=!1,c=!0),c&&(l[r.UserInfoField].updated_at=p,l=await t.ReplaceOne({_id:l._id},l,e),f(l),h.push(l))}return void c(h)}catch(e){return void y(e)}}))},n},i}}},249:(e,t,r)=>{"use strict";const n=r(147),o=r(17),i=r(632)();e.exports=function(e,t,s){let a={Adapters:{},Filters:{},LoadPlugin:function(e){if("o"===i.ShortType(e))if(e.AdapterName){if(void 0!==a.Adapters[e.AdapterName])throw new Error(`Storage adapter [${e.AdapterName}] already exists.`);a.Adapters[e.AdapterName]=e}else{if(!e.FilterName)return null;if(void 0!==a.Filters[e.FilterName])throw new Error(`Storage filter [${e.FilterName}] already exists.`);a.Filters[e.FilterName]=e}return e},LoadPlugins:function(e,t){if(!n.existsSync(e))throw new Error(`The path [${e}] does not exist.`);let i=n.readdirSync(e,{withFileTypes:!0});for(let n=0;n<i.length;n++){let s=i[n];if(s.isDirectory()&&t)a.LoadPlugins(o.join(e,s.name),!0);else if(s.isFile())try{let t=o.join(e,s.name);a.LoadPlugin(r(875)(t))}catch(e){console.error(e)}}},GetStorage:function(e,t,r){if(!"olu".includes(i.ShortType(t)))throw new Error("The Settings parameter must be an object, null, or undefined.");if("lu".includes(i.ShortType(t))&&(t={}),void 0===a.Adapters[e])throw new Error(`Storage adapter [${e}] is not loaded.`);let n=a.Adapters[e].GetAdapter(a,t);if(n.AdapterName=e,Array.isArray(r))for(let e=0;e<r.length;e++){let t=r[e];if("o"!==i.ShortType(t))throw new Error("The Filters parameter must be an array of filter entries: { FilterName: '...', Settings: {...} }.");if(void 0===t.FilterName)throw new Error("The FilterName field is required.");if(void 0===a.Filters[t.FilterName])throw new Error(`Storage filter [${t.FilterName}] is not loaded.`);n=a.Filters[t.FilterName].GetFilter(a,n,t.Settings),n.FilterName=t.FilterName}return n},GetFilter:function(e,t,r){if("s"!==i.ShortType(e))throw new Error("The FilterName field must be a string.");if(!"olu".includes(i.ShortType(r)))throw new Error("The Settings parameter must be an object, null, or undefined.");if("lu".includes(i.ShortType(r))&&(r={}),void 0===a.Filters[e])throw new Error(`Storage filter [${e}] is not loaded.`);let n=a.Filters[e].GetFilter(a,t,r);return n.FilterName=e,n},StorageInterface:function(){return{DropStorage:async function(e){throw new Error("DropStorage is not implemeted.")},FlushStorage:async function(e){throw new Error("FlushStorage is not implemeted.")},Count:async function(e,t){throw new Error("Count is not implemeted.")},InsertOne:async function(e,t){throw new Error("InsertOne is not implemeted.")},InsertMany:async function(e,t){throw new Error("InsertMany is not implemeted.")},FindOne:async function(e,t,r){throw new Error("FindOne is not implemeted.")},FindMany:async function(e,t,r){throw new Error("FindMany is not implemeted.")},UpdateOne:async function(e,t,r){throw new Error("UpdateOne is not implemeted.")},UpdateMany:async function(e,t,r){throw new Error("UpdateMany is not implemeted.")},ReplaceOne:async function(e,t,r){throw new Error("ReplaceOne is not implemeted.")},DeleteOne:async function(e,t){throw new Error("DeleteOne is not implemeted.")},DeleteMany:async function(e,t){throw new Error("DeleteMany is not implemeted.")}}},SqlExpression:c};function u(e,t,r){if(!"bnsla".includes(i.ShortType(t)))return null;if("o"!==i.ShortType(r))throw new Error("The Options parameter must be an object.");let n="";return r.FieldName&&(n+=`${r.IdentifierQuotes}${r.FieldName}${r.IdentifierQuotes} `),e&&(n+=e+" "),n+=c(t,r),n}function l(e,t){if("a"!==i.ShortType(e))return null;if("o"!==i.ShortType(t))throw new Error("The Options parameter must be an object.");if(0===e.length)return null;let r=[];for(let n=0;n<e.length;n++){let o=c(e[n],t);r.push(o)}return r}function c(e,t={}){let r=i.Clone(t);switch(void 0===r.StringLiteralQuotes&&(r.StringLiteralQuotes='"'),void 0===r.IdentifierQuotes&&(r.IdentifierQuotes=""),void 0===r.AllowDocumentPaths&&(r.AllowDocumentPaths=!1),void 0===r.FieldName&&(r.FieldName=""),i.ShortType(e)){case"b":if(!0===e)return"TRUE";if(!1===e)return"FALSE";throw new Error("SqlExpression: Internal error 101");case"n":return""+e;case"s":return e=e.replace(r.StringLiteralQuotes,`\\${r.StringLiteralQuotes}`),`${r.StringLiteralQuotes}${e}${r.StringLiteralQuotes}`;case"l":return"NULL";case"a":{let t=[];for(let r=0;r<e.length;r++){if(!"bnsl".includes(i.ShortType(e[r])))throw new Error("SqlExpression: Invalid array value.");t.push(c(e[r]))}return"("+t.join(", ")+")"}case"o":{let t=[];for(let n in e){let o=e[n];if(n.startsWith("$"))switch(n){case"$and":{if("a"!==i.ShortType(o))throw new Error(`SqlExpression: The operator [${n}] must be followed by an array.`);let e=l(o,r);if(!e)continue;let s="";s=1===e.length?t[0]:e.join(" AND "),t.push(`(${s})`)}break;case"$or":{if("a"!==i.ShortType(o))throw new Error(`SqlExpression: The operator [${n}] must be followed by an array.`);let e=l(o,r);if(!e)continue;let s="";s=1===e.length?t[0]:e.join(" OR "),t.push(`(${s})`)}break;case"$nor":{if("a"!==i.ShortType(o))throw new Error(`SqlExpression: The operator [${n}] must be followed by an array.`);let e=l(o,r);if(!e)continue;let s="";s=1===e.length?t[0]:e.join(" OR "),t.push(`(NOT (${s}))`)}break;case"$not":{let e=c(o,r);t.push(`(NOT ${e})`)}break;case"$eq":case"$eqx":{let e=u("=",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$ne":case"$nex":{let e=u("<>",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$lt":{let e=u("<",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$lte":{let e=u("<=",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$gt":{let e=u(">",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$gte":{let e=u(">=",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$in":{let e=u("IN",o,r);if(!e)continue;t.push(`(${e})`)}break;case"$nin":{let e=u("IN",o,r);if(!e)continue;t.push(`(NOT (${e}))`)}break;default:throw new Error(`SqlExpression: Invalid operator [${n}] found at this level. Expected a logical operator.`)}else{if(!r.AllowDocumentPaths&&n.includes("."))continue;let e=i.Clone(r);!e.StringLiteralQuotes&&n.includes(".")&&(e.StringLiteralQuotes='"'),e.FieldName=n;let s="";"bnsla".includes(i.ShortType(o))?(s=u("=",o,e),s=`(${s})`):s=c(o,e),t.push(s)}}return t.length?1===t.length?t[0]:"("+t.join(" AND ")+")":""}default:throw new Error(`SqlExpression: The Criteria [${JSON.stringify(e)}] is invalid.`)}return null}return a.LoadPlugin(r(54)),a.LoadPlugin(r(337)),a.LoadPlugin(r(514)),a.LoadPlugin(r(121)),a.LoadPlugin(r(976)),"string"==typeof e?a.GetStorage(e,t,s):a}},875:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=875,e.exports=t},632:e=>{"use strict";e.exports=require("@liquicode/jsongin")},828:e=>{"use strict";e.exports=require("uuid")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}return r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r(249)})()));